<html>
	<head>
		<title></title>
		<style>
			body {font-family:arial;font-size:14px;}
			td {font-size:14px;}
		</style>
	</head>
	<body>
	    <table border="1">
			<tr>
				<td colspan="9">header<br>struct</td>
				<td colspan="7">parts <span style="color:gray;">(compressed & encrypted)</span><br>array</td>
				<td>padding<br>0-15 bytes</td>
			</tr>
			<tr>
				<td colspan="5">public header<br>struct</td>
				<td colspan="4">protected header <span style="color:gray;">(encrypted)</span><br>struct</td>
				<td colspan="7">part n<br>struct</td>
			</tr>
			<tr>
				<td>protocol version<br>1 byte</td>
				<td>message type<br>1 byte</td>
				<td>message index<br>2 byte</td>
				<td>message length<br>4 byte</td>
				<td>session id<br>16 byte</td>

				<td>time<br>8 byte</td>
				<td>compression<br>1 byte</td>
				<td>part count<br>1 byte</td>
				<td>checksum<br>32 byte</td>

				<td>part type<br>1 byte</td>
				<td>part length<br>4 byte</td>
				<td>service name<br>utf8 string</td>
				<td>method name<br>utf8 string</td>
				<td>parameter count<br>1 byte</td>
				<td>parameter n<br>serialized object</td>
			</tr>
		</table>

		<br>
		<h2>Protocol security validations</h2>
		<b>server</b>
		<li>request message index equals most recent request message index plus one</li>
		<li>request time is equal or greater than most recent request time</li>
		<b>client</b>
		<li>response message index equals request message index</li>
		<li>response time is equal or greater than most recent response time</li>

		<br>
		<h2>Handshake protocol:</h2>
		<table border="1">
			<tr>
				<td>client</td>
				<td>eve</td>
				<td>server</td>
			</tr>
			<tr>
				<td>
				C1. => "login"<br>
				C1. => userName<br>
				</td>
			</tr>
			<tr>
				<td></td>
				<td>
					userName = &lt;login name in clear-text&gt;
				</td>
			</tr>
			<tr>
				<td></td>
				<td></td>
				<td>
				S1. <= userName<br>
				S1. serverNonce = RND <span style="color:red">[16]</span><br>
				S2. passwordSalt = &lt;get password salt from database&gt; <span style="color:red">[16]</span><br>
				S3. => "challange"<br>
				S3. => serverNonce</span><br>
				S3. => passwordSalt<br>
				</td>
			</tr>
			<tr>
				<td></td>
				<td>
					serverNonce = RND<br>
					passwordSalt<br>
				</td>
			</tr>
			<tr>
				<td>
				C2. <= serverNonce<br>
				C2. <= passwordSalt<br>
				C2. clientNonce = RND <span style="color:red">[16]</span><br>
				C3. secretKey = PBKDF2(passwordSalt, clearTextPassword) <span style="color:red">[16]</span><br>
				C4. clientAnswer = HASH(clientNonce | secretKey | serverNonce) <span style="color:red">[32]</span><br>
				C5. => "authenticate"<br>
				C5. => clientNonce<br>
				C5. => clientAnswer<br>
				</td>
			</tr>
			<tr>
				<td></td>
				<td>
					clientNonce = RND<br>
					clientAnswer = HASH(clientNonce | PBKDF2(passwordSalt, clearTextPassword) | serverNonce)<br>
				</td>
			</tr>
			<tr>
				<td></td>
				<td></td>
				<td>
				S4. <= clientNonce<br>
				S4. <= clientAnswer<br>
				S4. secretKey = &lt;get precomputed secret key from database&gt; <span style="color:red">[16]</span><br>
				S5. serverVerification = HASH(clientNonce | secretKey | serverNonce) <span style="color:red">[32]</span><br>
				S6. confirm clientAnswer equals serverVerification<br>
				S7. serverAnswer = HASH(serverNonce | secretKey | clientNonce) <span style="color:red">[32]</span><br>
				S8. masterKey = HASH(clientAnswer | serverAnswer | secretKey) <span style="color:red">[32]</span><br>
				S9. clientKey = masterKey[0..15]<br>
				S9. serverKey = masterKey[16..31]<br>
				S10. => "authorized"<br>
				S10. => serverAnswer<br>
				</td>
			</tr>
			<tr>
				<td></td>
				<td>
					serverAnswer = HASH(serverNonce | PBKDF2(passwordSalt, clearTextPassword) | clientNonce)<br>
				</td>
			</tr>
			<tr>
				<td>
				C6. <= serverAnswer<br>
				C6. clientVerification = HASH(serverNonce | secretKey | clientNonce) <span style="color:red">[32]</span><br>
				C7. confirm serverAnswer equals clientVerification<br>
				C8. masterKey = HASH(clientAnswer | serverAnswer | secretKey) <span style="color:red">[32]</span><br>
				C9. clientKey = masterKey[0..15]<br>
				C9. serverKey = masterKey[16..31]<br>
				</td>
			</tr>
		</table>

		<h2>Message IV</h2>
		IV = E(sessionID xor messageIndex)
	</body>
</html>
